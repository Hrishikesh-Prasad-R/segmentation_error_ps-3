<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GenAI Data Quality Agent</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            900: '#0c4a6e',
                        },
                        glass: 'rgba(255, 255, 255, 0.1)',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #f8fafc;
            min-height: 100vh;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .loader {
            border-top-color: #3498db;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }

        @keyframes spinner {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .modal-backdrop {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
        }
    </style>
</head>

<body class="p-6">

    <div class="max-w-7xl mx-auto space-y-6">

        <!-- Header -->
        <header class="flex justify-between items-center py-4">
            <div class="flex items-center space-x-3">
                <div
                    class="w-10 h-10 bg-gradient-to-tr from-cyan-500 to-blue-600 rounded-lg flex items-center justify-center shadow-lg shadow-cyan-500/20">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div>
                    <h1
                        class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-blue-400">
                        GenAI DQS Agent</h1>
                    <p class="text-xs text-slate-400">Universal Payment Data Quality Scoring</p>
                </div>
            </div>
            <div
                class="text-sm font-medium text-slate-400 bg-slate-800/50 px-3 py-1 rounded-full border border-slate-700">
                <span class="w-2 h-2 rounded-full bg-green-500 inline-block mr-2"></span> System Ready
            </div>
        </header>

        <!-- Upload Section -->
        <!-- Upload Section -->
        <div id="upload-section"
            class="glass-panel rounded-2xl p-10 text-center border-2 border-dashed border-slate-600 hover:border-cyan-500 transition-colors cursor-pointer group relative overflow-hidden">

            <!-- Standard File Input (Multiple) -->
            <input type="file" id="fileInput" class="hidden" accept=".csv,.json,.xlsx" multiple
                onchange="handleFiles(this.files)">

            <!-- Folder Input -->
            <input type="file" id="folderInput" class="hidden" webkitdirectory directory
                onchange="handleFiles(this.files)">

            <div class="relative z-10 pointer-events-none">
                <div
                    class="w-16 h-16 bg-slate-700/50 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:bg-cyan-500/20 transition-colors">
                    <svg class="w-8 h-8 text-slate-400 group-hover:text-cyan-400 transition-colors" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                        </path>
                    </svg>
                </div>
                <h2 class="text-xl font-semibold text-white mb-2">Upload Payment Data</h2>
                <p class="text-slate-400 text-sm max-w-md mx-auto mb-6">
                    Upload individual files or <span class="text-cyan-400 font-semibold">entire folders</span> for batch
                    analysis.
                </p>

                <div class="relative z-20 flex justify-center gap-4 pointer-events-auto">
                    <button onclick="document.getElementById('fileInput').click()"
                        class="px-5 py-2 bg-slate-800 hover:bg-slate-700 text-white border border-slate-600 rounded-lg text-sm font-medium transition-all">
                        üìÑ Select Files
                    </button>
                    <button onclick="document.getElementById('folderInput').click()"
                        class="px-5 py-2 bg-slate-800 hover:bg-slate-700 text-cyan-400 border border-cyan-500/30 rounded-lg text-sm font-medium transition-all">
                        üìÇ Select Folder
                    </button>
                </div>

                <!-- Advanced Controls -->
                <div class="relative z-20 mt-4 flex justify-center items-center pointer-events-auto">
                    <label class="flex items-center space-x-2 cursor-pointer group">
                        <input type="checkbox" id="simulateFailure"
                            class="form-checkbox h-4 w-4 text-red-500 rounded border-slate-600 bg-slate-700/50 focus:ring-red-500/50 hover:bg-slate-700 transition">
                        <span class="text-xs text-slate-400 group-hover:text-red-400 transition-colors">‚ö° Simulate AI
                            Failure (Circuit Breaker)</span>
                    </label>
                </div>

                <div class="relative z-20 mt-6 pt-6 border-t border-slate-700/50 space-x-3 pointer-events-auto">
                    <button onclick="runDemo(event)"
                        class="px-4 py-1.5 bg-slate-800/50 hover:bg-cyan-900/30 text-cyan-500 text-xs border border-cyan-500/20 rounded-full transition-all">
                        ‚ñ∂ Run Single Demo
                    </button>
                    <button onclick="runDemo(event)"
                        class="px-4 py-1.5 bg-slate-800/50 hover:bg-purple-900/30 text-purple-400 text-xs border border-purple-500/20 rounded-full transition-all">
                        üìÅ Run Folder Demo
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading" class="hidden flex flex-col items-center justify-center py-20">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-slate-700 h-12 w-12 mb-4"></div>
            <p class="text-cyan-400 animate-pulse font-medium">GenAI Agent Analyzing Dimensions...</p>
            <p class="text-xs text-slate-500 mt-2">Checking Completeness, Accuracy, Consistency...</p>
        </div>

        <!-- Results Dashboard -->
        <div id="dashboard" class="hidden space-y-6">

            <!-- Top Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Composite Score -->
                <div class="glass-panel rounded-2xl p-6 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-cyan-500/10 rounded-full blur-2xl -mr-10 -mt-10">
                    </div>
                    <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-4">Composite Quality
                        Score</h3>
                    <div class="flex items-end space-x-2">
                        <span id="composite-score" class="text-6xl font-bold text-white">0.0</span>
                        <span class="text-lg text-slate-500 mb-2">/ 100</span>
                    </div>
                    <div id="overall-status"
                        class="mt-4 inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-slate-800 text-slate-300">
                        Analyzing...
                    </div>
                </div>

                <!-- AI Insight -->
                <div class="glass-panel rounded-2xl p-6 col-span-2 relative">
                    <div class="flex items-start space-x-4">
                        <div class="p-2 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-lg shrink-0">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-white font-semibold text-lg mb-1">GenAI Executive Summary</h3>
                            <p id="summary-text" class="text-slate-300 text-sm leading-relaxed">
                                Our agent has processed your dataset. Please review the detailed dimension breakdown
                                below. The system has applied the "Rules > ML" logical containment to ensure safety.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dimensions Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" id="dimensions-container">
                <!-- Dimensions will be injected here -->
            </div>

            <!-- WHY NOT BLACK BOX Section -->
            <div
                class="glass-panel rounded-xl p-6 border border-purple-500/30 bg-gradient-to-r from-purple-900/20 to-indigo-900/20">
                <div class="flex items-center space-x-3 mb-4">
                    <div class="p-2 bg-purple-500/20 rounded-lg">
                        <svg class="w-6 h-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-white font-semibold text-lg">Why This is NOT a Black Box</h3>
                        <p class="text-xs text-purple-300">Full Transparency & Explainability</p>
                    </div>
                    <button onclick="toggleExplainability()"
                        class="ml-auto text-xs bg-purple-500/20 hover:bg-purple-500/40 text-purple-300 px-3 py-1 rounded-full transition">
                        Show Details
                    </button>
                </div>

                <div id="explainability-content" class="hidden space-y-4">
                    <!-- Transparency Guarantees -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-slate-800/50 rounded-lg p-3">
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="text-green-400">‚úì</span>
                                <span class="text-white text-sm font-medium">Formula-Based Scoring</span>
                            </div>
                            <p class="text-xs text-slate-400">All 7 dimensions use explicit mathematical formulas,
                                not
                                learned weights.</p>
                        </div>
                        <div class="bg-slate-800/50 rounded-lg p-3">
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="text-green-400">‚úì</span>
                                <span class="text-white text-sm font-medium">Rules > ML</span>
                            </div>
                            <p class="text-xs text-slate-400">Machine Learning is advisory only. Deterministic rules
                                always take authority.</p>
                        </div>
                        <div class="bg-slate-800/50 rounded-lg p-3">
                            <div class="flex items-center space-x-2 mb-2">
                                <span class="text-green-400">‚úì</span>
                                <span class="text-white text-sm font-medium">Auditable Logs</span>
                            </div>
                            <p class="text-xs text-slate-400">Every decision is logged with timestamp, inputs,
                                outputs,
                                and rationale.</p>
                        </div>
                    </div>

                    <!-- Formulas Section -->
                    <div class="bg-slate-900/50 rounded-lg p-4">
                        <h4 class="text-sm font-semibold text-purple-300 mb-3">üìê Scoring Formulas (Fully
                            Transparent)
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs font-mono">
                            <div class="flex justify-between"><span class="text-slate-400">Completeness:</span><span
                                    class="text-cyan-400">100 √ó (1 - nulls/total)</span></div>
                            <div class="flex justify-between"><span class="text-slate-400">Accuracy:</span><span
                                    class="text-cyan-400">100 √ó (1 - issues/rows)</span></div>
                            <div class="flex justify-between"><span class="text-slate-400">Validity:</span><span
                                    class="text-cyan-400">100 √ó (1 - invalid/checks)</span></div>
                            <div class="flex justify-between"><span class="text-slate-400">Uniqueness:</span><span
                                    class="text-cyan-400">100 √ó (1 - dupes/rows)</span></div>
                        </div>
                    </div>

                    <!-- ML Methods Section -->
                    <div class="bg-slate-900/50 rounded-lg p-4">
                        <h4 class="text-sm font-semibold text-purple-300 mb-3">üî¨ ML Methods (Explainable, Not Deep
                            Learning)</h4>
                        <div class="space-y-2 text-xs">
                            <div class="flex items-start space-x-2">
                                <span class="text-cyan-400 mt-0.5">‚Üí</span>
                                <div>
                                    <span class="text-white">Z-Score Outlier Detection:</span>
                                    <span class="text-slate-400 ml-1">z = (value - mean) / std. Flagged if |z| >
                                        2.5œÉ</span>
                                </div>
                            </div>
                            <div class="flex items-start space-x-2">
                                <span class="text-cyan-400 mt-0.5">‚Üí</span>
                                <div>
                                    <span class="text-white">Category Analysis:</span>
                                    <span class="text-slate-400 ml-1">Compares value to category-specific baseline
                                        statistics</span>
                                </div>
                            </div>
                            <div class="flex items-start space-x-2">
                                <span class="text-cyan-400 mt-0.5">‚Üí</span>
                                <div>
                                    <span class="text-white">Temporal Patterns:</span>
                                    <span class="text-slate-400 ml-1">Detects burst activity exceeding 2œÉ from daily
                                        mean</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Decision Logic -->
                    <div class="bg-slate-900/50 rounded-lg p-4">
                        <h4 class="text-sm font-semibold text-purple-300 mb-3">‚öôÔ∏è Decision Logic (Finite State
                            Machine)
                        </h4>
                        <div class="overflow-x-auto">
                            <table class="w-full text-xs">
                                <thead>
                                    <tr class="text-left text-slate-400 border-b border-slate-700">
                                        <th class="pb-2">Decision</th>
                                        <th class="pb-2">Condition</th>
                                        <th class="pb-2">Human Override</th>
                                    </tr>
                                </thead>
                                <tbody class="text-slate-300">
                                    <tr class="border-b border-slate-800">
                                        <td class="py-2 text-green-400">SAFE_TO_USE</td>
                                        <td>DQS ‚â• 75%, Anomalies ‚â§ 5, No violations</td>
                                        <td class="text-yellow-400">Allowed</td>
                                    </tr>
                                    <tr class="border-b border-slate-800">
                                        <td class="py-2 text-yellow-400">REVIEW_REQUIRED</td>
                                        <td>DQS ‚â• 50%, OR Anomalies > 5</td>
                                        <td class="text-yellow-400">Required</td>
                                    </tr>
                                    <tr>
                                        <td class="py-2 text-red-400">ESCALATE</td>
                                        <td>DQS < 30%, OR Critical violations</td>
                                        <td class="text-red-400">Mandatory</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Governance Log -->
            <div class="glass-panel rounded-xl p-4 border border-slate-700/50">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="text-xs font-semibold text-slate-400 uppercase">Responsibility Boundary & Audit Trace
                    </h4>
                    <span class="text-[10px] bg-slate-800 px-2 py-0.5 rounded text-slate-500">REAL-TIME LOGS</span>
                </div>
                <div id="audit-log"
                    class="h-40 overflow-y-auto font-mono text-xs text-slate-400 space-y-1 p-2 bg-slate-900/50 rounded-lg">
                    <!-- Logs injected here -->
                </div>
            </div>

        </div>
    </div>

    <!-- Template for Dimension Card -->
    <template id="dimension-card-template">
        <div class="glass-panel rounded-xl p-5 hover:bg-slate-800/50 transition-colors border-l-4 border-transparent">
            <div class="flex justify-between items-start mb-3">
                <h4 class="text-white font-medium text-lg dimension-name">Dimension</h4>
                <div class="text-xs font-bold px-2 py-1 rounded bg-slate-800 dimension-score">0.0</div>
            </div>

            <div class="w-full bg-slate-700 rounded-full h-1.5 mb-4">
                <div class="bg-cyan-500 h-1.5 rounded-full dimension-bar" style="width: 0%"></div>
            </div>

            <div class="space-y-3">
                <div>
                    <span class="text-[10px] text-slate-500 uppercase">Status & Explanation</span>
                    <p class="text-xs text-slate-300 mt-0.5 dimension-explanation">Loading...</p>
                </div>
                <div>
                    <span class="text-[10px] text-slate-500 uppercase">Recommendation</span>
                    <p class="text-xs text-cyan-400 mt-0.5 dimension-recommendation">Waiting...</p>
                </div>
                <div class="flex items-center space-x-2 pt-2 border-t border-slate-700/50">
                    <span class="text-[10px] text-slate-500">ML Confidence: </span>
                    <span class="text-[10px] text-white dimension-confidence">0%</span>
                </div>
            </div>
        </div>
    </template>

    <script>
        function runDemo(e) {
            e.stopPropagation(); // Prevent file upload trigger
            document.getElementById('upload-section').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');

            // Simulate processing delay
            setTimeout(() => {
                const mockData = {
                    "composite_score": 78.5,
                    "overall_status": "Review-required",
                    "summary": "AI Analysis: Moderate quality (78.5). Rules passed, but ML detected anomalies in accuracy. Recommended actions: Review high-value transactions manually.",
                    "dimensions": [
                        {
                            "dimension": "Completeness",
                            "score": 100,
                            "confidence": 99.0,
                            "explanation": "No missing values detected in critical fields.",
                            "status": "Safe-to-use",
                            "recommendation": "Maintain checks."
                        },
                        {
                            "dimension": "Accuracy",
                            "score": 65.0,
                            "confidence": 45.0,
                            "explanation": "ML Confidence low (45%). Rules passed but AI detects anomalies.",
                            "status": "Review-required",
                            "recommendation": "Manual verification of recent transactions."
                        },
                        {
                            "dimension": "Consistency",
                            "score": 92.0,
                            "confidence": 88.0,
                            "explanation": "Data consistency is high across tables.",
                            "status": "Safe-to-use",
                            "recommendation": "None."
                        },
                        {
                            "dimension": "Timeliness",
                            "score": 50.0,
                            "confidence": 95.0,
                            "explanation": "Critical Rule: Value Date is in the past > 30 days.",
                            "status": "Escalate",
                            "recommendation": "Reject batch."
                        }
                    ],
                    "logs": [
                        "Starting Analysis...",
                        "Identified Dimensions: Completeness, Accuracy, Consistency, Timeliness",
                        "Evaluating Completeness...",
                        "  Rules: 100, ML: 99. Safe.",
                        "Evaluating Accuracy...",
                        "  Rules: Pass, ML Confidence: 45%.",
                        "  > Conflict detected. Logic prioritizes Safety -> Review-required.",
                        "Evaluating Timeliness...",
                        "  > CRITICAL FLAG detected. Rules Override ML. Status: Escalate.",
                        "Analysis Complete. Composite Score: 78.5"
                    ]
                };
                renderDashboard(mockData);
            }, 2000);
        }

        async function handleFiles(fileList) {
            if (!fileList || fileList.length === 0) return;

            // UI Transition
            document.getElementById('upload-section').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');
            const loadingText = document.querySelector('#loading p.animate-pulse');

            const results = [];

            try {
                // Process files sequentially
                for (let i = 0; i < fileList.length; i++) {
                    const file = fileList[i];
                    loadingText.innerText = `Analyzing ${file.name} (${i + 1}/${fileList.length})...`;

                    const formData = new FormData();
                    formData.append('file', file);

                    const simulateFailure = document.getElementById('simulateFailure').checked;
                    const response = await fetch(`/analyze?simulate_failure=${simulateFailure}`, {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const data = await response.json();
                        data.filename = file.name;
                        results.push(data);
                    }
                }

                if (results.length > 0) {
                    renderMultiDashboard(results);
                } else {
                    throw new Error("No files were successfully analyzed");
                }

            } catch (error) {
                console.error(error);
                alert('Analysis failed. See console for details.');
                location.reload();
            }
        }

        function renderMultiDashboard(results) {
            document.getElementById('loading').classList.add('hidden');
            const dashboard = document.getElementById('dashboard');
            dashboard.classList.remove('hidden');

            // Clear existing content to rebuild
            dashboard.innerHTML = '';

            // 1. GLOBAL SUMMARY HEADER
            const avgScore = results.reduce((acc, r) => acc + r.composite_score, 0) / results.length;
            const criticalCount = results.filter(r => r.overall_status === 'Escalate').length;
            const reviewCount = results.filter(r => r.overall_status === 'Review-required').length;

            const summaryHTML = `
                <div class="glass-panel rounded-2xl p-6 mb-8 border border-white/10 relative overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-r from-cyan-900/20 to-purple-900/20"></div>
                    <div class="relative z-10 flex flex-col md:flex-row justify-between items-center gap-6">
                        <div>
                            <h2 class="text-2xl font-bold text-white mb-1">Batch Analysis Report</h2>
                            <p class="text-slate-400 text-sm">Processed <span class="text-white font-mono">${results.length}</span> datasets.</p>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="flex gap-4 text-center">
                                <div class="px-4 py-2 bg-slate-800/50 rounded-lg">
                                    <div class="text-xs text-slate-500 uppercase">DQS Score</div>
                                    <div class="text-2xl font-bold text-white">${avgScore.toFixed(1)}</div>
                                </div>
                                <div class="px-4 py-2 bg-slate-800/50 rounded-lg">
                                    <div class="text-xs text-slate-500 uppercase">Critical</div>
                                    <div class="text-2xl font-bold text-red-400">${criticalCount}</div>
                                </div>
                                <div class="px-4 py-2 bg-slate-800/50 rounded-lg">
                                    <div class="text-xs text-slate-500 uppercase">Review</div>
                                    <div class="text-2xl font-bold text-yellow-400">${reviewCount}</div>
                                </div>
                            </div>
                            <button onclick="resetToUpload()" class="px-4 py-2 bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-400 hover:to-blue-500 text-white font-semibold rounded-lg shadow-lg shadow-cyan-500/25 transition-all flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                New Analysis
                            </button>
                        </div>
                    </div>
                </div>
            `;
            dashboard.insertAdjacentHTML('beforeend', summaryHTML);

            // 2. RENDER INDIVIDUAL CARDS
            results.forEach((data, index) => {
                const datasetId = `dataset-${index}`;
                const statusColor = data.overall_status === 'Escalate' ? 'text-red-400 border-red-500/50' :
                    (data.overall_status === 'Review-required' ? 'text-yellow-400 border-yellow-500/50' : 'text-green-400 border-green-500/50');

                const cardHTML = `
                    <div class="glass-panel rounded-xl border border-slate-700/50 overflow-hidden mb-6">
                        <!-- HEADER -->
                        <div class="p-4 bg-slate-800/50 border-b border-white/5 flex flex-wrap items-center justify-between gap-4 cursor-pointer hover:bg-slate-700/30 transition-colors"
                             onclick="toggleSection('${datasetId}')">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-slate-700 rounded text-slate-300 font-mono text-xs">#${index + 1}</div>
                                <div>
                                    <h3 class="text-lg font-semibold text-white">${data.filename}</h3>
                                    <div class="text-xs text-slate-400 flex gap-2">
                                        <span>DQS: <b class="${data.composite_score < 50 ? 'text-red-400' : 'text-cyan-400'}">${data.composite_score}</b></span>
                                        <span>‚Ä¢</span>
                                        <span>${data.overall_status}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="px-3 py-1 rounded-full border ${statusColor} text-xs font-bold uppercase tracking-wide">
                                ${data.overall_status}
                            </div>
                        </div>
                        
                        <!-- BODY (Expandable) -->
                        <div id="${datasetId}" class="p-6 space-y-6 ${index === 0 ? '' : 'hidden'}">
                            
                            <!-- GenAI Summary -->
                            <div class="p-5 bg-gradient-to-r from-purple-900/30 to-indigo-900/30 rounded-xl border border-purple-500/40 shadow-lg shadow-purple-500/10">
                                <div class="flex items-center gap-2 mb-3">
                                    <div class="p-1.5 bg-purple-500/30 rounded-lg">
                                        <svg class="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                    </div>
                                    <h4 class="text-sm font-bold text-purple-300 uppercase tracking-wide">ü§ñ GenAI Executive Summary</h4>
                                </div>
                                <p class="text-base text-white leading-relaxed font-medium">${data.summary || 'GenAI summary not available. Check GEMINI_API_KEY environment variable.'}</p>
                            </div>
                            
                            <!-- Dimensions Grid -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                ${data.dimensions.map(dim => renderDimensionCard(dim)).join('')}
                            </div>
                            
                            <!-- Why Not Black Box Panel -->
                            <div class="p-4 rounded-lg border border-cyan-900/30 bg-cyan-950/10">
                                <div class="flex items-center gap-2 mb-3">
                                    <svg class="w-4 h-4 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                    <h4 class="text-sm font-semibold text-cyan-100">Why This Is Not A Black Box</h4>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-xs text-cyan-200/80">
                                    <div>
                                        <b class="text-cyan-400">Scoring:</b> Formulas are explicit.<br>
                                        Ex: Accuracy = 100 * (1 - issues/rows)
                                    </div>
                                    <div>
                                        <b class="text-cyan-400">Decision:</b> Deterministic FSM.<br>
                                        Rules always override ML signals.
                                    </div>
                                    <div>
                                        <b class="text-cyan-400">Audit:</b> Trace ID: ${data.logs.find(l => l.includes('Trace ID'))?.split('Trace ID: ')[1] || 'Generated'}
                                    </div>
                                </div>
                            </div>

                            <!-- Audit Logs with Tabs -->
                            <div class="rounded-lg border border-white/10 overflow-hidden">
                                <!-- Tab Header -->
                                <div class="flex items-center justify-between bg-slate-800/80 px-3 py-2 border-b border-white/5">
                                    <div class="flex gap-1">
                                        <button onclick="switchLogTab('${datasetId}', 'summary')" 
                                            id="${datasetId}-tab-summary"
                                            class="px-3 py-1.5 text-xs font-medium rounded-md bg-cyan-500/20 text-cyan-400 border border-cyan-500/30 transition-all">
                                            üìã Summarised
                                        </button>
                                        <button onclick="switchLogTab('${datasetId}', 'full')"
                                            id="${datasetId}-tab-full" 
                                            class="px-3 py-1.5 text-xs font-medium rounded-md text-slate-400 hover:bg-slate-700 transition-all">
                                            üìú Entire Log
                                        </button>
                                    </div>
                                    <button onclick="downloadLog('${data.filename}', '${datasetId}')" 
                                        class="flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium rounded-md bg-green-500/20 text-green-400 border border-green-500/30 hover:bg-green-500/30 transition-all">
                                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                        Download
                                    </button>
                                </div>
                                
                                <!-- Summarised Log (Default) -->
                                <div id="${datasetId}-log-summary" class="p-3 bg-black/40 font-mono text-[11px] text-slate-400 h-40 overflow-y-auto">
                                    <div class="space-y-1">
                                        <div class="text-cyan-400">‚îÅ‚îÅ‚îÅ Analysis Summary ‚îÅ‚îÅ‚îÅ</div>
                                        <div>üìä DQS Score: <span class="text-white font-bold">${data.composite_score}%</span></div>
                                        <div>üéØ Status: <span class="${data.overall_status === 'SAFE_TO_USE' ? 'text-green-400' : data.overall_status === 'ESCALATE' ? 'text-red-400' : 'text-yellow-400'}">${data.overall_status}</span></div>
                                        <div>üìÅ File: ${data.filename}</div>
                                        <div>üîñ Trace ID: ${data.trace_id || 'Generated'}</div>
                                        <div class="text-cyan-400 mt-2">‚îÅ‚îÅ‚îÅ Dimension Scores ‚îÅ‚îÅ‚îÅ</div>
                                        ${data.dimensions.map(d => `<div>  ${d.score >= 90 ? '‚úÖ' : d.score >= 70 ? '‚ö†Ô∏è' : '‚ùå'} ${d.dimension}: ${d.score}%</div>`).join('')}
                                        <div class="text-cyan-400 mt-2">‚îÅ‚îÅ‚îÅ Key Findings ‚îÅ‚îÅ‚îÅ</div>
                                        <div>üîç Anomalies: ${data.anomalies?.length || 0}</div>
                                        <div>üë§ Responsible: ${data.responsible_party || 'System'}</div>
                                        <div>üìã Confidence: ${data.confidence_band} (${data.confidence_score}%)</div>
                                    </div>
                                </div>
                                
                                <!-- Full Log (Hidden by default) -->
                                <div id="${datasetId}-log-full" class="hidden p-3 bg-black/40 font-mono text-[10px] text-slate-500 h-40 overflow-y-auto">
                                    ${data.logs.map(l => `<div>> ${l}</div>`).join('')}
                                </div>
                                
                                <!-- Hidden full log data for download -->
                                <textarea id="${datasetId}-log-data" class="hidden">${JSON.stringify({
                    filename: data.filename,
                    trace_id: data.trace_id,
                    composite_score: data.composite_score,
                    overall_status: data.overall_status,
                    dimensions: data.dimensions,
                    anomalies: data.anomalies,
                    logs: data.logs,
                    responsible_party: data.responsible_party,
                    confidence_band: data.confidence_band,
                    confidence_score: data.confidence_score
                }, null, 2)}</textarea>
                            </div>
                        </div>
                    </div>
                `;
                dashboard.insertAdjacentHTML('beforeend', cardHTML);
            });
        }

        function renderDimensionCard(dim) {
            let color = 'bg-cyan-500';
            let borderColor = 'border-cyan-500/30';
            if (dim.score < 70) { color = 'bg-red-500'; borderColor = 'border-red-500/50'; }
            else if (dim.score < 90) { color = 'bg-yellow-500'; borderColor = 'border-yellow-500/50'; }

            // Escape data for onclick
            const dimData = encodeURIComponent(JSON.stringify(dim));

            return `
                <div class="glass-panel p-4 rounded-lg relative overflow-hidden group hover:border-white/30 hover:scale-[1.02] transition-all cursor-pointer border ${borderColor}" 
                     onclick="showDimensionModal(decodeURIComponent('${dimData}'))">
                    <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <span class="text-[9px] bg-purple-500/30 text-purple-300 px-2 py-0.5 rounded-full">Click for fixes</span>
                    </div>
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-sm font-medium text-white">${dim.dimension}</span>
                        <span class="text-xs font-bold text-slate-300">${dim.score}</span>
                    </div>
                    <div class="w-full bg-slate-700 h-1.5 rounded-full mb-3">
                        <div class="${color} h-1.5 rounded-full transition-all" style="width: ${dim.score}%"></div>
                    </div>
                    <p class="text-[10px] text-slate-400 leading-tight mb-2 h-8 overflow-hidden">${dim.explanation}</p>
                    <div class="flex justify-between items-center text-[10px] text-slate-500 pt-2 border-t border-white/5">
                        <span>Conf: ${dim.confidence}%</span>
                        <span class="uppercase tracking-wider ${dim.status === 'CRITICAL' ? 'text-red-400' : ''}">${dim.status}</span>
                    </div>
                </div>
            `;
        }

        function showDimensionModal(dimDataStr) {
            const dim = JSON.parse(dimDataStr);

            // Generate terminal commands based on dimension
            const terminalCommands = getTerminalCommands(dim.dimension, dim.score);
            const aiSuggestions = getAISuggestions(dim.dimension, dim.score, dim.explanation);

            const modalHTML = `
                <div id="dimension-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop" onclick="if(event.target.id==='dimension-modal') closeModal()">
                    <div class="glass-panel rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto border border-white/10 shadow-2xl">
                        <!-- Header -->
                        <div class="p-6 border-b border-white/10 bg-gradient-to-r from-slate-800 to-slate-900">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h2 class="text-2xl font-bold text-white mb-1">${dim.dimension}</h2>
                                    <p class="text-slate-400 text-sm">Data Quality Dimension Analysis</p>
                                </div>
                                <div class="text-right">
                                    <div class="text-3xl font-bold ${dim.score >= 90 ? 'text-green-400' : dim.score >= 70 ? 'text-yellow-400' : 'text-red-400'}">${dim.score}%</div>
                                    <div class="text-xs text-slate-500 uppercase">${dim.status}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Content -->
                        <div class="p-6 space-y-6">
                            <!-- Issue Summary -->
                            <div class="p-4 bg-slate-800/50 rounded-lg border-l-4 ${dim.score >= 70 ? 'border-cyan-500' : 'border-red-500'}">
                                <h3 class="text-sm font-bold text-white mb-2">üìã Issue Summary</h3>
                                <p class="text-slate-300 text-sm">${dim.explanation}</p>
                            </div>
                            
                            <!-- Terminal Commands -->
                            <div class="p-4 bg-black/40 rounded-lg border border-green-900/30">
                                <div class="flex items-center gap-2 mb-3">
                                    <span class="text-green-400">‚å®Ô∏è</span>
                                    <h3 class="text-sm font-bold text-green-400">Terminal Commands to Fix</h3>
                                </div>
                                <div class="space-y-2 font-mono text-xs">
                                    ${terminalCommands.map(cmd => `
                                        <div class="flex items-start gap-2 p-2 bg-black/60 rounded border border-green-900/20 hover:border-green-500/50 transition-colors group">
                                            <span class="text-green-500 select-none">$</span>
                                            <code class="text-green-300 flex-1">${cmd.command}</code>
                                            <button onclick="navigator.clipboard.writeText('${cmd.command.replace(/'/g, "\\'")}')"
                                                class="opacity-0 group-hover:opacity-100 text-slate-500 hover:text-green-400 transition-all text-[10px]">
                                                üìã Copy
                                            </button>
                                        </div>
                                        <p class="text-slate-500 text-[10px] ml-4 mb-2">${cmd.description}</p>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- GenAI Suggestions -->
                            <div class="p-4 bg-gradient-to-r from-purple-900/30 to-indigo-900/30 rounded-lg border border-purple-500/30">
                                <div class="flex items-center gap-2 mb-3">
                                    <span class="text-purple-400">ü§ñ</span>
                                    <h3 class="text-sm font-bold text-purple-300">GenAI Suggestions</h3>
                                </div>
                                <div class="space-y-3">
                                    ${aiSuggestions.map((sug, i) => `
                                        <div class="flex items-start gap-3">
                                            <span class="w-5 h-5 rounded-full bg-purple-500/30 text-purple-300 text-xs flex items-center justify-center shrink-0">${i + 1}</span>
                                            <p class="text-slate-300 text-sm">${sug}</p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- Recommendation -->
                            <div class="p-4 bg-cyan-900/20 rounded-lg border border-cyan-500/30">
                                <h3 class="text-sm font-bold text-cyan-400 mb-2">‚úÖ Recommended Action</h3>
                                <p class="text-white text-sm font-medium">${dim.recommendation}</p>
                            </div>
                        </div>
                        
                        <!-- Footer -->
                        <div class="p-4 border-t border-white/10 flex justify-end">
                            <button onclick="closeModal()" class="px-6 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeModal() {
            const modal = document.getElementById('dimension-modal');
            if (modal) modal.remove();
        }

        function getTerminalCommands(dimension, score) {
            const commands = {
                'Completeness': [
                    { command: "python -c \"import pandas as pd; df = pd.read_csv('data.csv'); print(df.isnull().sum())\"", description: "Check null counts per column" },
                    { command: "python -c \"import pandas as pd; df = pd.read_csv('data.csv'); df.fillna(method='ffill', inplace=True); df.to_csv('data_fixed.csv')\"", description: "Forward-fill missing values" },
                    { command: "python -c \"import pandas as pd; df = pd.read_csv('data.csv'); df.dropna(subset=['transaction_id','amount'], inplace=True); df.to_csv('data_clean.csv')\"", description: "Drop rows with critical nulls" }
                ],
                'Accuracy': [
                    { command: "python -c \"import pandas as pd; df = pd.read_csv('data.csv'); print(df[df['amount'] < 0])\"", description: "Find negative amounts" },
                    { command: "python -c \"import pandas as pd; df = pd.read_csv('data.csv'); df['amount'] = df['amount'].abs(); df.to_csv('data_fixed.csv')\"", description: "Convert negative to absolute values" },
                    { command: "grep -i 'TEST\\|TEMP\\|XXX' data.csv", description: "Find placeholder values in file" }
                ],
                'Validity': [
                    { command: "python -c \"import pandas as pd; df = pd.read_csv('data.csv'); df['date'] = pd.to_datetime(df['date'], errors='coerce'); print(df[df['date'].isna()])\"", description: "Find invalid dates" },
                    { command: "python -c \"import pandas as pd; df = pd.read_csv('data.csv'); print(df[df['amount'] > 1000000])\"", description: "Find extreme amounts" },
                    { command: "python -c \"import pandas as pd; df = pd.read_csv('data.csv'); df = df[(df['amount'] > 0) & (df['amount'] < 1000000)]; df.to_csv('data_valid.csv')\"", description: "Filter valid amount range" }
                ],
                'Uniqueness': [
                    { command: "python -c \"import pandas as pd; df = pd.read_csv('data.csv'); print(df[df.duplicated()])\"", description: "Show duplicate rows" },
                    { command: "python -c \"import pandas as pd; df = pd.read_csv('data.csv'); df.drop_duplicates(inplace=True); df.to_csv('data_unique.csv')\"", description: "Remove duplicate rows" },
                    { command: "python -c \"import pandas as pd; df = pd.read_csv('data.csv'); print(df[df['transaction_id'].duplicated()])\"", description: "Find duplicate transaction IDs" }
                ],
                'Consistency': [
                    { command: "python -c \"import pandas as pd; df = pd.read_csv('data.csv'); print(df.groupby('status')['amount'].describe())\"", description: "Check amount distribution by status" },
                    { command: "python -c \"import pandas as pd; df = pd.read_csv('data.csv'); print(df[(df['status']=='FAILED') & (df['amount']>10000)])\"", description: "Find inconsistent failed high-value txns" }
                ],
                'Timeliness': [
                    { command: "python -c \"import pandas as pd; df = pd.read_csv('data.csv'); df['date'] = pd.to_datetime(df['date']); print(df['date'].min(), df['date'].max())\"", description: "Check date range" },
                    { command: "python -c \"import pandas as pd; df = pd.read_csv('data.csv'); df['date'] = pd.to_datetime(df['date']); print((pd.Timestamp.now() - df['date'].max()).days, 'days old')\"", description: "Check data freshness" }
                ],
                'Integrity': [
                    { command: "python -c \"import pandas as pd; df = pd.read_csv('data.csv'); print(df['transaction_id'].str.len().describe())\"", description: "Check ID format consistency" },
                    { command: "python -c \"import pandas as pd; df = pd.read_csv('data.csv'); print(df.dtypes)\"", description: "Verify column data types" }
                ]
            };
            return commands[dimension] || [
                { command: "python -c \"import pandas as pd; df = pd.read_csv('data.csv'); print(df.describe())\"", description: "General data statistics" }
            ];
        }

        function getAISuggestions(dimension, score, explanation) {
            const baseSuggestions = {
                'Completeness': [
                    "Consider implementing data validation at the source system to prevent null values from entering the pipeline.",
                    "For critical fields like transaction_id and amount, set up NOT NULL constraints in your database schema.",
                    "Use imputation strategies (mean, median, mode) for non-critical numerical fields based on business context."
                ],
                'Accuracy': [
                    "Set up input validation rules to reject values outside expected ranges before data ingestion.",
                    "Implement regex patterns to catch placeholder values like 'TEST', 'N/A', 'TBD' during ETL.",
                    "Create a data quality dashboard to monitor accuracy metrics over time and catch regressions."
                ],
                'Validity': [
                    "Define and enforce business rules for valid value ranges in your data contracts.",
                    "Implement date parsing with explicit format specifications to catch malformed dates early.",
                    "Consider adding validation layers in your API that reject out-of-range values."
                ],
                'Uniqueness': [
                    "Add unique constraints on transaction_id in your database to prevent duplicates at source.",
                    "Implement idempotency keys for payment processing to avoid duplicate transactions.",
                    "Set up deduplication logic in your ETL pipeline using composite keys."
                ],
                'Consistency': [
                    "Establish data contracts between teams to ensure consistent field semantics.",
                    "Implement cross-field validation rules (e.g., failed transactions should have specific patterns).",
                    "Use enum types for categorical fields to enforce consistency."
                ],
                'Timeliness': [
                    "Set up automated data refresh schedules to ensure data currency.",
                    "Implement data staleness alerts when data age exceeds business-defined thresholds.",
                    "Consider streaming or near-real-time data pipelines for time-sensitive use cases."
                ],
                'Integrity': [
                    "Standardize ID formats using a consistent pattern (e.g., UUID, prefixed sequences).",
                    "Implement referential integrity checks for foreign key relationships.",
                    "Add schema validation to enforce data type consistency across the pipeline."
                ]
            };

            let suggestions = baseSuggestions[dimension] || [
                "Review the data quality issues and implement appropriate fixes.",
                "Consider adding automated validation to prevent similar issues."
            ];

            // Add score-specific advice
            if (score < 50) {
                suggestions.unshift("‚ö†Ô∏è CRITICAL: This dimension requires immediate attention. Block data usage until resolved.");
            } else if (score < 70) {
                suggestions.unshift("‚ö° Priority: Address these issues before using this data in production.");
            }

            return suggestions;
        }

        function toggleSection(id) {
            const section = document.getElementById(id);
            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
            } else {
                section.classList.add('hidden');
            }
        }

        function resetToUpload() {
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('dashboard').innerHTML = '';
            document.getElementById('upload-section').classList.remove('hidden');
            // Reset file inputs
            document.getElementById('fileInput').value = '';
            document.getElementById('folderInput').value = '';
        }

        function switchLogTab(datasetId, tab) {
            const summaryTab = document.getElementById(`${datasetId}-tab-summary`);
            const fullTab = document.getElementById(`${datasetId}-tab-full`);
            const summaryLog = document.getElementById(`${datasetId}-log-summary`);
            const fullLog = document.getElementById(`${datasetId}-log-full`);

            if (tab === 'summary') {
                summaryTab.className = 'px-3 py-1.5 text-xs font-medium rounded-md bg-cyan-500/20 text-cyan-400 border border-cyan-500/30 transition-all';
                fullTab.className = 'px-3 py-1.5 text-xs font-medium rounded-md text-slate-400 hover:bg-slate-700 transition-all';
                summaryLog.classList.remove('hidden');
                fullLog.classList.add('hidden');
            } else {
                fullTab.className = 'px-3 py-1.5 text-xs font-medium rounded-md bg-cyan-500/20 text-cyan-400 border border-cyan-500/30 transition-all';
                summaryTab.className = 'px-3 py-1.5 text-xs font-medium rounded-md text-slate-400 hover:bg-slate-700 transition-all';
                fullLog.classList.remove('hidden');
                summaryLog.classList.add('hidden');
            }
        }

        function downloadLog(filename, datasetId) {
            const logData = document.getElementById(`${datasetId}-log-data`).value;
            const data = JSON.parse(logData);

            // Create formatted log content
            let content = `================================================================================
GenAI Data Quality Agent - Analysis Report
================================================================================
Generated: ${new Date().toISOString()}
File: ${data.filename}
Trace ID: ${data.trace_id}

================================================================================
SUMMARY
================================================================================
Composite DQS Score: ${data.composite_score}%
Overall Status: ${data.overall_status}
Confidence: ${data.confidence_band} (${data.confidence_score}%)
Responsible Party: ${data.responsible_party}

================================================================================
DIMENSION SCORES
================================================================================
`;
            data.dimensions.forEach(d => {
                content += `${d.dimension.padEnd(15)} ${String(d.score).padStart(6)}%  [${d.status}]\n`;
                content += `                 ${d.explanation}\n`;
                content += `                 Recommendation: ${d.recommendation}\n\n`;
            });

            content += `================================================================================
ANOMALIES DETECTED (${data.anomalies?.length || 0})
================================================================================
`;
            if (data.anomalies && data.anomalies.length > 0) {
                data.anomalies.forEach((a, i) => {
                    content += `[${i + 1}] Row ${a.row}, Column: ${a.column}\n`;
                    content += `    Severity: ${a.severity} | Detector: ${a.detector}\n`;
                    content += `    Reason: ${a.reason}\n\n`;
                });
            } else {
                content += `No anomalies detected.\n\n`;
            }

            content += `================================================================================
FULL EXECUTION LOG
================================================================================
`;
            data.logs.forEach(log => {
                content += `> ${log}\n`;
            });

            content += `
================================================================================
END OF REPORT
================================================================================`;

            // Download
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dqs_report_${filename.replace(/\.[^/.]+$/, '')}_${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Retain runDemo for legacy support if needed, or redirect
        function runDemo(e) {
            e.stopPropagation();
            alert("Please use the 'Upload Payment Data' section to select specific files or folders for the demo.");
            // Or implement a mock version of handleFiles if strictly simulated
        }

        function animateValue(obj, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = (progress * (end - start) + start).toFixed(1);
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        function toggleExplainability() {
            const content = document.getElementById('explainability-content');
            const button = event.target;
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                button.textContent = 'Hide Details';
            } else {
                content.classList.add('hidden');
                button.textContent = 'Show Details';
            }
        }

        function runMultiDemo(e) {
            e.stopPropagation();
            document.getElementById('upload-section').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');

            // Simulate processing multiple files
            setTimeout(() => {
                const multiFileData = {
                    "composite_score": 78.6,
                    "overall_status": "Review-required",
                    "summary": "Multi-File Analysis Complete: 3 files processed. Average DQS: 78.6%. File 1 (payments_jan.csv): 92% SAFE. File 2 (payments_feb.csv): 71% REVIEW. File 3 (payments_mar.csv): 73% REVIEW. Recommendation: Review flagged items in files 2 and 3 before processing.",
                    "dimensions": [
                        { "dimension": "Completeness", "score": 95, "confidence": 98, "explanation": "Aggregated across 3 files. Minor gaps in file 3.", "status": "Safe-to-use", "recommendation": "Maintain checks." },
                        { "dimension": "Accuracy", "score": 78, "confidence": 72, "explanation": "File 2 has several format issues.", "status": "Review-required", "recommendation": "Validate file 2 data." },
                        { "dimension": "Validity", "score": 82, "confidence": 88, "explanation": "3 invalid currency codes found.", "status": "Review-required", "recommendation": "Standardize currency formats." },
                        { "dimension": "Uniqueness", "score": 88, "confidence": 95, "explanation": "2 cross-file duplicate IDs detected.", "status": "Review-required", "recommendation": "Check for duplicate transactions across files." }
                    ],
                    "logs": [
                        "[10:30:00.000] Multi-File Mode: 3 files detected",
                        "[10:30:00.100] Processing: payments_jan.csv (30 rows) ‚Üí DQS: 92%",
                        "[10:30:00.250] Processing: payments_feb.csv (45 rows) ‚Üí DQS: 71%",
                        "[10:30:00.400] Processing: payments_mar.csv (28 rows) ‚Üí DQS: 73%",
                        "[10:30:00.500] Cross-file duplicate check: 2 duplicates found",
                        "[10:30:00.550] Aggregating results...",
                        "[10:30:00.600] Combined DQS: 78.6% (weighted by row count)",
                        "[10:30:00.650] Decision: REVIEW_REQUIRED (File 2 has issues)",
                        "[10:30:00.700] Responsibility: HUMAN_DATA_STEWARD",
                        "[10:30:00.750] Multi-file report generated"
                    ]
                };
                renderDashboard(multiFileData);
            }, 2500);
        }
    </script>
</body>

</html>